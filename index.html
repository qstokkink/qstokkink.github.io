<!DOCTYPE html>
<html>
<head>
<script>
function csrByte() {
    var out = new Uint8Array(1);
    window.crypto.getRandomValues(out);
    return out[0];
}

function goodRandomByte(b) {
    var out = 0;
    while ((out == 0) || (b == out))
        out = csrByte();
    return out;
}

function createSplit(b, amount) {
    var out = [];
    var sR  = 0;
    for (i = 0; i < amount - 2; i++) {
        r   = goodRandomByte(b);
        sR  += r;
        sR  %= 256;
        out.push(r);
    }
    var sr  = goodRandomByte(b);
    out.push((256 + sr - sR) % 256);
    out.push((256 - sr + b) % 256);
    return out;
}

function createCanvasNodes(amount, hidden) {
    var out = [];
    for (i = 0; i < amount; i++) {
        var node = document.createElement('canvas');
        if (hidden){
            node.style.visibility = "hidden";
        }
        node.id = 'canvas' + i.toString();
        out.push(node);
    }
    return out;
}

function createImageNodes(dataURLs) {
    for (i = 0; i < dataURLs.length; i++) {
        var node = document.createElement('p');
        if (dataURLs.length > 1)
            node.innerHTML = "Result " + i.toString() + ":<br>";
        else
            node.innerHTML = "Result:<br>";
        var childImg = document.createElement('img');
        childImg.src = dataURLs[i];
        node.appendChild(childImg);
        addNodeToArea(node);
    }
}

function clearArea() {
    document.getElementById("resultarea").innerHTML = '';
}

function addNodeToArea(node) {
    document.getElementById("resultarea").appendChild(node);
}

DrawImageCallback = function(file, canvas, callback){
    this.img = new Image();
    this.canvas = canvas;
    this.callback = callback;
    this.cb = (function() {
        var ctx = this.canvas.getContext('2d');
        ctx.canvas.width = this.img.width;
        ctx.canvas.height = this.img.height;
        ctx.drawImage(this.img, 0, 0);
        addNodeToArea(this.canvas);
        this.callback(ctx);
    }).bind(this);
    this.img.onload = this.cb;
    this.img.src = URL.createObjectURL(file);
};

var dstCanvasses = [];
function doSplit(context) {
    var canvas = context.canvas;
    var amount = dstCanvasses.length;
    var pixels  = [];
    var contexts = [];
    for (i = 0; i < amount; i++) {
        contexts.push(dstCanvasses[i].getContext('2d'));
        pixels.push(contexts[i].createImageData(1,1));
        contexts[i].canvas.width    = context.canvas.width;
        contexts[i].canvas.height   = context.canvas.height;
    }
    for (x = 0; x < canvas.width; x++) {
        for (y = 0; y < canvas.height; y++) {
            var color = context.getImageData(x, y, 1, 1).data;
            var splitr = createSplit(color[0], amount);
            var splitg = createSplit(color[1], amount);
            var splitb = createSplit(color[2], amount);
            for (i = 0; i < amount; i++) {
                pixels[i].data[0] = splitr[i];
                pixels[i].data[1] = splitg[i];
                pixels[i].data[2] = splitb[i];
                pixels[i].data[3] = 255;
                contexts[i].putImageData(pixels[i],x,y);
            }
        }
    }
    dataURLs = [];
    for (i = 0; i < amount; i++) {
        dataURLs.push(dstCanvasses[i].toDataURL('image/png'));
    }
    createImageNodes(dataURLs);
    dstCanvasses = [];
}

function splitImage(obj) {
    // Read input
    var files   = obj.querySelector("#splitImgInputFile").files;
    var amount  = parseInt(obj.querySelector("#splitImgInputAmount").value);
    // Check input TODO
    // Initialize objects
    var canvasses       = createCanvasNodes(amount + 1, true);
    var srcCanvas       = canvasses[0];
    dstCanvasses        = canvasses.slice(1);
    clearArea();
    // Perform magic trick
    new DrawImageCallback(files[0], srcCanvas, doSplit);
}

var readyCanvasses = [];
function doCombine() {
    var canvas  = dstCanvasses[0];
    canvas.width = readyCanvasses[0].canvas.width;
    canvas.height = readyCanvasses[0].canvas.height;
    var amount  = readyCanvasses.length;
    var context = canvas.getContext('2d');
    var pixel   = context.createImageData(1,1);
    for (x = 0; x < canvas.width; x++) {
        for (y = 0; y < canvas.height; y++) {
            var color = readyCanvasses[0].getImageData(x, y, 1, 1).data;
            pixel.data[0] = color[0];
            pixel.data[1] = color[1];
            pixel.data[2] = color[2];
            pixel.data[3] = 255;
            for (i = 1; i < amount; i++) {
                c = readyCanvasses[i].getImageData(x, y, 1, 1).data;
                pixel.data[0] = (pixel.data[0] + c[0]) % 256;
                pixel.data[1] = (pixel.data[1] + c[1]) % 256;
                pixel.data[2] = (pixel.data[2] + c[2]) % 256;
            }
            context.putImageData(pixel,x,y);
        }
    }
    dataURLs = [];
    dataURLs.push(canvas.toDataURL('image/png'));
    createImageNodes(dataURLs);
    readyCanvasses = [];
}

var waitingCanvasses = 0;
function tryCombine(context) {
    readyCanvasses.push(context);
    if (--waitingCanvasses == 0) {
        doCombine();
    }
}

function combineImages(obj) {
    // Read input
    var files   = obj.querySelector("#combineImgInputFile").files;
    var amount  = files.length;
    // Check input TODO
    // Initialize objects
    var canvasses       = createCanvasNodes(amount + 1, true);
    var srcCanvasses    = canvasses.slice(1);
    dstCanvasses        = canvasses.slice(0, 1);
    clearArea();
    waitingCanvasses    = amount;
    readyCanvasses      = [];
    // Perform magic trick
    for (i = 0; i < amount; i++)
        new DrawImageCallback(files[i], srcCanvasses[i], tryCombine);
}
</script>
</head>
<body>

<div id="form" style="width:350px;">
<fieldset>
<legend>Split an image</legend>
<p>
Choose a file:<br>
<input type="file" id="splitImgInputFile">
</p>
<p>
Choose the amount of output files:<br>
<input type="number" id="splitImgInputAmount" min="3" max="200" value="3">
</p>
<input type="button" onclick="splitImage(this.parentNode)" value="CREATE" style="float:right">
</fieldset>
</div>

<div id="form" style="width:350px;">
<fieldset>
<legend>Combine images</legend>
<p>
Choose files:<br>
<input multiple type="file" id="combineImgInputFile">
</p>
<input type="button" onclick="combineImages(this.parentNode)" value="COMBINE" style="float:right">
</fieldset>
</div>


<!-- http://www.htmlgoodies.com/html5/tutorials/introducing-html-5-web-workers-bringing-multi-threading-to-javascript.html#fbid=OhDrcfoK5yX -->
<div id="resultarea">
</div>

</body>
</html>
